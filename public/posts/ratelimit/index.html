<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>漏桶限流库 — uber-go/ratelimit | Bazinga's Blog</title><meta name=keywords content="golang"><meta name=description content="漏桶限流库 — uber-go/ratelimit"><meta name=author content="Me"><link rel=canonical href=http://chown.xyz/posts/ratelimit/><link crossorigin=anonymous href=/assets/css/stylesheet.min.6cba0d81b5f3f42bb578d49f402ba4175aa72b43def148780b8ad714c957c6f5.css integrity="sha256-bLoNgbXz9Cu1eNSfQCukF1qnK0Pe8Uh4C4rXFMlXxvU=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=http://chown.xyz/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=http://chown.xyz/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=http://chown.xyz/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=http://chown.xyz/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=http://chown.xyz/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.84.0"><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-123-45','auto'),ga('send','pageview'))</script><meta property="og:title" content="漏桶限流库 — uber-go/ratelimit"><meta property="og:description" content="漏桶限流库 — uber-go/ratelimit"><meta property="og:type" content="article"><meta property="og:url" content="http://chown.xyz/posts/ratelimit/"><meta property="og:image" content="http://chown.xyz/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-12-03T00:00:00+00:00"><meta property="article:modified_time" content="2021-12-03T00:00:00+00:00"><meta property="og:site_name" content="Bazinga"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://chown.xyz/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="漏桶限流库 — uber-go/ratelimit"><meta name=twitter:description content="漏桶限流库 — uber-go/ratelimit"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"http://chown.xyz/posts/"},{"@type":"ListItem","position":3,"name":"漏桶限流库 — uber-go/ratelimit","item":"http://chown.xyz/posts/ratelimit/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"漏桶限流库 — uber-go/ratelimit","name":"漏桶限流库 — uber-go\/ratelimit","description":"漏桶限流库 — uber-go/ratelimit","keywords":["golang"],"articleBody":"上次有同学分享了 单机限流器 time/rate 库，讲了 Golang 标准库中基于令牌桶实现限流组件的 time/rate 使用，同时也讲了一些限流算法原理。\n这里分享一个 uber 开源的一套基于漏桶实现的用于服务限流的 golang 库 ratelimit。\n漏洞算法的理解起来，相较于令牌桶，没有那么直观。因为令牌桶是限制 “令牌” 的速率，拿到令牌的请求才能被放行，而漏桶是限制单位时间内允许通过的请求数目，调用方只能严格按照预定的间隔顺序进行消费调用。\nratelimit 的基本使用 官方示例：\nimport ( \"fmt\" \"time\" \"go.uber.org/ratelimit\" ) func main() { rl := ratelimit.New(100) // per second  prev := time.Now() for i := 0; i 10; i++ { now := rl.Take() fmt.Println(i, now.Sub(prev)) prev = now } } 在这个例子中，我们给定限流器每秒可以通过 100 个请求，也就是平均每个请求间隔 10ms。 因此，最终会每 10ms 打印一行数据。输出结果如下：\n// Output: // 0 0 // 1 10ms // 2 10ms // 3 10ms // 4 10ms // 5 10ms // 6 10ms // 7 10ms // 8 10ms // 9 10ms 高级用法 最大松弛量 传统的漏桶，每个请求的间隔是固定、匀速的，两次请求 req1 和 req2 之间的延迟至少应该 =perRequest，然而，在实际上的应用中，流量经常是突发性的。 对于突发这种情况，uber-go 对 Leaky Bucket 做了一些改良，引入了最大松弛量（maxSlack）的概念, 表示允许抵消的最长时间\n漏桶算法的限速逻辑：\nsleepFor = t.perRequest - now.Sub(t.last) if sleepFor  0 { t.clock.Sleep(sleepFor) t.last = now.Add(sleepFor) } else { t.last = now } 上面计算 sleepFor 的代码，不使用最大松弛量的 sleep 逻辑，严格要求两个请求之间必须间隔 t.perRequest 的时间，那么计算 sleepFor 的代码就是：\nt.sleepFor = t.perRequest - now.Sub(t.last) 这样就会有以下问题：\n我们假设现在有三个请求，req1、req2 和 req3，限速区间为 10ms。 req1 最先到来，当 req1 完成之后 15ms ，req2 才到来，依据限速策略可以对 req2 立即处理，当 req2 完成后，5ms 后， req3 到来，这个时候距离上次请求还不足 10ms，因此还需要等待 5ms 才能继续执行, 但是，对于这种情况，实际上这三个请求一共消耗了 25ms 才完成，并不是预期的 20ms。\n上面这个 case 模拟了一种请求量突发的状况。但这里我们可以把之前间隔比较长的请求的时间（累加超出 perRequest 的时延），匀给后面的请求判断限流时使用。 对于上面的 case，因为 req2 相当于多等了 5ms，我们可以把这 5ms 移给 req3 使用。加上 req3 本身就是 5ms 之后过来的，一共刚好 10ms，所以 req3 无需等待，直接可以处理。此时三个请求也恰好一共是 20ms。如下：\nt.sleepFor += t.perRequest - now.Sub(t.last) if t.sleepFor  0 { t.clock.Sleep(t.sleepFor) t.last = now.Add(t.sleepFor) t.sleepFor = 0 } else { t.last = now } 当 t.sleepFor  0，代表此前的请求多余出来的时间，无法完全抵消此次的所需量，因此需要 sleep 相应时间, 同时将 t.sleepFor 置为 0。\n当 t.sleepFor ，说明此次请求间隔大于预期间隔，将多出来的时间累加到 t.sleepFor 即可。\n但是，对于某种情况，请求 1 完成后，请求 2 过了很久到达 ，那么此时对于请求 2 的请求间隔 now.Sub(t.last)，会非常大。以至于即使后面大量请求瞬时到达，也无法抵消完这个时间。那这样就失去了限流的意义。\n为了防止这种情况，ratelimit 就引入了最大松弛量 (maxSlack) 的概念, 该值为负值，表示允许抵消的最长时间，防止以上情况的出现。\n// 当计算出来的 sleepFor 超过一个 maxSlack 时，那么就只 sleep 一个 maxSlack 时间，用于两次请求时间间隔过大的场景 if t.sleepFor ratelimit 中 maxSlack 的值为 -10 * time.Second / time.Duration(rate), 是十个请求的间隔大小。我们也可以理解为 ratelimit 允许的最大瞬时请求为 10。\n用法 ratelimit 的 New 函数，除了可以配置每秒请求数 (QPS)， 还提供了一套可选配置项 Option。\nfunc New(rate int, opts ...Option) Limiter WithoutSlack 上面说到 ratelimit 中引入了最大松弛量的概念，而且默认的最大松弛量为 10 个请求的间隔时间。\n但是对于需要严格的限制请求的固定间隔的时，我们可以利用 WithoutSlack 来取消松弛量的影响。\nlimiter := ratelimit.New(100, ratelimit.WithoutSlack) 另外，ratelimit 还有其他选项，比如WithClock(clock Clock) 可以用来替换默认时钟，来实现精度更高或者特殊需求的计时场景。\nReference uber-go 漏桶限流器使用与原理分析 | 编程沉思录 (cyhone.com)\n开源限流组件分析（一）：Uber 的 Leaky Bucket - 熊喵君的博客 | PANDAYCHEN\n限流算法之一 | hzSomthing (hedzr.com)\nuber-go/ratelimit: A Golang blocking leaky-bucket rate limit implementation (github.com)\n","wordCount":"338","inLanguage":"en","datePublished":"2021-12-03T00:00:00Z","dateModified":"2021-12-03T00:00:00Z","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://chown.xyz/posts/ratelimit/"},"publisher":{"@type":"Organization","name":"Bazinga's Blog","logo":{"@type":"ImageObject","url":"http://chown.xyz/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add('dark')</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style></noscript><header class=header><nav class=nav><div class=logo><a href=http://chown.xyz accesskey=h title="Bazinga's Blog (Alt + H)">Bazinga's Blog</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=http://chown.xyz/categories/ title=Categories><span>Categories</span></a></li><li><a href=http://chown.xyz/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=http://chown.xyz>Home</a>&nbsp;»&nbsp;<a href=http://chown.xyz/posts/>Posts</a></div><h1 class=post-title>漏桶限流库 — uber-go/ratelimit</h1><div class=post-meta>December 3, 2021&nbsp;·&nbsp;2 min&nbsp;·&nbsp;Me&nbsp;|&nbsp;<a href=https://github.com/%3cpath_to_repo%3e/content/posts/ratelimit.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><div class=details>Table of Contents</div></summary><div class=inner><ul><li><a href=#ratelimit-%e7%9a%84%e5%9f%ba%e6%9c%ac%e4%bd%bf%e7%94%a8 aria-label="ratelimit 的基本使用">ratelimit 的基本使用</a></li><li><a href=#%e9%ab%98%e7%ba%a7%e7%94%a8%e6%b3%95 aria-label=高级用法>高级用法</a><ul><li><a href=#%e6%9c%80%e5%a4%a7%e6%9d%be%e5%bc%9b%e9%87%8f aria-label=最大松弛量>最大松弛量</a></li><li><a href=#%e7%94%a8%e6%b3%95 aria-label=用法>用法</a></li><li><a href=#withoutslack aria-label=WithoutSlack><code>WithoutSlack</code></a></li></ul></li><li><a href=#reference aria-label=Reference>Reference</a></li></ul></div></details></div><div class=post-content><p>上次有同学分享了 <a href=https://gocn.vip/topics/12239>单机限流器 time/rate 库</a>，讲了 Golang 标准库中基于令牌桶实现限流组件的 <code>time/rate</code> 使用，同时也讲了一些限流算法原理。</p><p>这里分享一个 uber 开源的一套基于漏桶实现的用于服务限流的 golang 库 <a href=https://github.com/uber-go/ratelimit/>ratelimit</a>。</p><p>漏洞算法的理解起来，相较于令牌桶，没有那么直观。因为令牌桶是限制 “令牌” 的速率，拿到令牌的请求才能被放行，而漏桶是限制单位时间内允许通过的请求数目，调用方只能严格按照预定的间隔顺序进行消费调用。</p><h2 id=ratelimit-的基本使用>ratelimit 的基本使用<a hidden class=anchor aria-hidden=true href=#ratelimit-的基本使用>#</a></h2><p>官方示例：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>import</span> (
	<span style=color:#e6db74>&#34;fmt&#34;</span>
	<span style=color:#e6db74>&#34;time&#34;</span>

	<span style=color:#e6db74>&#34;go.uber.org/ratelimit&#34;</span>
)

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
    <span style=color:#a6e22e>rl</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ratelimit</span>.<span style=color:#a6e22e>New</span>(<span style=color:#ae81ff>100</span>) <span style=color:#75715e>// per second
</span><span style=color:#75715e></span>
    <span style=color:#a6e22e>prev</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#ae81ff>10</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
        <span style=color:#a6e22e>now</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rl</span>.<span style=color:#a6e22e>Take</span>()
        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>now</span>.<span style=color:#a6e22e>Sub</span>(<span style=color:#a6e22e>prev</span>))
        <span style=color:#a6e22e>prev</span> = <span style=color:#a6e22e>now</span>
    }
}

</code></pre></div><p>在这个例子中，我们给定限流器每秒可以通过 100 个请求，也就是平均每个请求间隔 10ms。
因此，最终会每 10ms 打印一行数据。输出结果如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// Output:
</span><span style=color:#75715e>// 0 0
</span><span style=color:#75715e>// 1 10ms
</span><span style=color:#75715e>// 2 10ms
</span><span style=color:#75715e>// 3 10ms
</span><span style=color:#75715e>// 4 10ms
</span><span style=color:#75715e>// 5 10ms
</span><span style=color:#75715e>// 6 10ms
</span><span style=color:#75715e>// 7 10ms
</span><span style=color:#75715e>// 8 10ms
</span><span style=color:#75715e>// 9 10ms
</span></code></pre></div><h2 id=高级用法>高级用法<a hidden class=anchor aria-hidden=true href=#高级用法>#</a></h2><h3 id=最大松弛量>最大松弛量<a hidden class=anchor aria-hidden=true href=#最大松弛量>#</a></h3><p>传统的漏桶，每个请求的间隔是固定、匀速的，两次请求 req1 和 req2 之间的延迟至少应该 >=perRequest，然而，在实际上的应用中，流量经常是突发性的。
对于突发这种情况，uber-go 对 Leaky Bucket 做了一些改良，引入了最大松弛量（maxSlack）的概念, 表示允许抵消的最长时间</p><p>漏桶算法的限速逻辑：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>sleepFor</span> = <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>perRequest</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>now</span>.<span style=color:#a6e22e>Sub</span>(<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>last</span>)
<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sleepFor</span> &gt; <span style=color:#ae81ff>0</span> {
	<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>clock</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>sleepFor</span>)
	<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>last</span> = <span style=color:#a6e22e>now</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>sleepFor</span>)
} <span style=color:#66d9ef>else</span> {
	<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>last</span> = <span style=color:#a6e22e>now</span>
}
</code></pre></div><p>上面计算 sleepFor 的代码，不使用最大松弛量的 sleep 逻辑，严格要求两个请求之间必须间隔 <code>t.perRequest</code> 的时间，那么计算 <code>sleepFor</code> 的代码就是：</p><pre><code>t.sleepFor = t.perRequest - now.Sub(t.last)
</code></pre><p>这样就会有以下问题：</p><p>我们假设现在有三个请求，<code>req1</code>、<code>req2</code> 和 <code>req3</code>，限速区间为 <code>10ms</code>。
<code>req1</code> 最先到来，当 <code>req1</code> 完成之后 <code>15ms</code> ，<code>req2</code> 才到来，依据限速策略可以对 <code>req2</code> 立即处理，当 <code>req2</code> 完成后，<code>5ms</code> 后， <code>req3</code> 到来，这个时候距离上次请求还不足 <code>10ms</code>，因此还需要等待 <code>5ms</code> 才能继续执行, 但是，对于这种情况，实际上这三个请求一共消耗了 <code>25ms</code> 才完成，并不是预期的 <code>20ms</code>。</p><p>上面这个 case 模拟了一种请求量突发的状况。但这里我们可以把之前间隔比较长的请求的时间（累加超出 <code>perRequest</code> 的时延），匀给后面的请求判断限流时使用。 对于上面的 case，因为 <code>req2</code> 相当于多等了 <code>5ms</code>，我们可以把这 <code>5ms</code> 移给 <code>req3</code> 使用。加上 <code>req3</code> 本身就是 <code>5ms</code> 之后过来的，一共刚好 <code>10ms</code>，所以 <code>req3</code> 无需等待，直接可以处理。此时三个请求也恰好一共是 <code>20ms</code>。如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>sleepFor</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>perRequest</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>now</span>.<span style=color:#a6e22e>Sub</span>(<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>last</span>)
<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>sleepFor</span> &gt; <span style=color:#ae81ff>0</span> {
  <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>clock</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>sleepFor</span>)
  <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>last</span> = <span style=color:#a6e22e>now</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>sleepFor</span>)
  <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>sleepFor</span> = <span style=color:#ae81ff>0</span>
} <span style=color:#66d9ef>else</span> {
  <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>last</span> = <span style=color:#a6e22e>now</span>
}
</code></pre></div><p>当 <code>t.sleepFor > 0</code>，代表此前的请求多余出来的时间，无法完全抵消此次的所需量，因此需要 sleep 相应时间, 同时将 <code>t.sleepFor</code> 置为 0。</p><p>当 <code>t.sleepFor &lt; 0</code>，说明此次请求间隔大于预期间隔，将多出来的时间累加到 <code>t.sleepFor</code> 即可。</p><p>但是，对于某种情况，请求 1 完成后，请求 2 过了很久到达 ，那么此时对于请求 2 的请求间隔 <code>now.Sub(t.last)</code>，会非常大。以至于即使后面大量请求瞬时到达，也无法抵消完这个时间。那这样就失去了限流的意义。</p><p>为了防止这种情况，ratelimit 就引入了最大松弛量 (maxSlack) 的概念, 该值为负值，表示允许抵消的最长时间，防止以上情况的出现。</p><pre><code>// 当计算出来的 sleepFor 超过一个 maxSlack 时，那么就只 sleep 一个 maxSlack 时间，用于两次请求时间间隔过大的场景
if t.sleepFor &lt; t.maxSlack {
	t.sleepFor = t.maxSlack
}
</code></pre><p>ratelimit 中 maxSlack 的值为 <code>-10 * time.Second / time.Duration(rate)</code>, 是十个请求的间隔大小。我们也可以理解为 ratelimit 允许的最大瞬时请求为 10。</p><h3 id=用法>用法<a hidden class=anchor aria-hidden=true href=#用法>#</a></h3><p>ratelimit 的 New 函数，除了可以配置每秒请求数 (QPS)， 还提供了一套可选配置项 Option。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>rate</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>opts</span> <span style=color:#f92672>...</span><span style=color:#a6e22e>Option</span>) <span style=color:#a6e22e>Limiter</span>
</code></pre></div><h3 id=withoutslack><code>WithoutSlack</code><a hidden class=anchor aria-hidden=true href=#withoutslack>#</a></h3><p>上面说到 ratelimit 中引入了最大松弛量的概念，而且默认的最大松弛量为 10 个请求的间隔时间。</p><p>但是对于需要严格的限制请求的固定间隔的时，我们可以利用 WithoutSlack 来取消松弛量的影响。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>limiter</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ratelimit</span>.<span style=color:#a6e22e>New</span>(<span style=color:#ae81ff>100</span>, <span style=color:#a6e22e>ratelimit</span>.<span style=color:#a6e22e>WithoutSlack</span>)
</code></pre></div><p>另外，ratelimit 还有其他选项，比如<code>WithClock(clock Clock)</code> 可以用来替换默认时钟，来实现精度更高或者特殊需求的计时场景。</p><h2 id=reference>Reference<a hidden class=anchor aria-hidden=true href=#reference>#</a></h2><p><a href=https://www.cyhone.com/articles/analysis-of-uber-go-ratelimit/>uber-go 漏桶限流器使用与原理分析 | 编程沉思录 (cyhone.com)</a></p><p><a href=https://pandaychen.github.io/2020/07/31/A-UBER-LEAKY-BUCKET-LIMITER-ANALYSIS/>开源限流组件分析（一）：Uber 的 Leaky Bucket - 熊喵君的博客 | PANDAYCHEN</a></p><p><a href=https://hedzr.com/golang/algorithm/rate-limit-1/#%E6%AF%94%E8%BE%83>限流算法之一 | hzSomthing (hedzr.com)</a></p><p><a href=https://github.com/uber-go/ratelimit>uber-go/ratelimit: A Golang blocking leaky-bucket rate limit implementation (github.com)</a></p></div><footer class=post-footer><ul class=post-tags><li><a href=http://chown.xyz/tags/golang/>golang</a></li></ul><nav class=paginav><a class=prev href=http://chown.xyz/posts/gohook/><span class=title>« Prev Page</span><br><span>运行时替换 Golang 函数 — gohook</span></a>
<a class=next href=http://chown.xyz/posts/retry/><span class=title>Next Page »</span><br><span>重试工具 — retry-go</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share 漏桶限流库 — uber-go/ratelimit on twitter" href="https://twitter.com/intent/tweet/?text=%e6%bc%8f%e6%a1%b6%e9%99%90%e6%b5%81%e5%ba%93%20%e2%80%94%20uber-go%2fratelimit&url=http%3a%2f%2fchown.xyz%2fposts%2fratelimit%2f&hashtags=golang"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 漏桶限流库 — uber-go/ratelimit on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2fchown.xyz%2fposts%2fratelimit%2f&title=%e6%bc%8f%e6%a1%b6%e9%99%90%e6%b5%81%e5%ba%93%20%e2%80%94%20uber-go%2fratelimit&summary=%e6%bc%8f%e6%a1%b6%e9%99%90%e6%b5%81%e5%ba%93%20%e2%80%94%20uber-go%2fratelimit&source=http%3a%2f%2fchown.xyz%2fposts%2fratelimit%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 漏桶限流库 — uber-go/ratelimit on reddit" href="https://reddit.com/submit?url=http%3a%2f%2fchown.xyz%2fposts%2fratelimit%2f&title=%e6%bc%8f%e6%a1%b6%e9%99%90%e6%b5%81%e5%ba%93%20%e2%80%94%20uber-go%2fratelimit"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 漏桶限流库 — uber-go/ratelimit on facebook" href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2fchown.xyz%2fposts%2fratelimit%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 漏桶限流库 — uber-go/ratelimit on whatsapp" href="https://api.whatsapp.com/send?text=%e6%bc%8f%e6%a1%b6%e9%99%90%e6%b5%81%e5%ba%93%20%e2%80%94%20uber-go%2fratelimit%20-%20http%3a%2f%2fchown.xyz%2fposts%2fratelimit%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 漏桶限流库 — uber-go/ratelimit on telegram" href="https://telegram.me/share/url?text=%e6%bc%8f%e6%a1%b6%e9%99%90%e6%b5%81%e5%ba%93%20%e2%80%94%20uber-go%2fratelimit&url=http%3a%2f%2fchown.xyz%2fposts%2fratelimit%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2023 <a href=http://chown.xyz>Bazinga's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>